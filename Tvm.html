<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Télécommande OQEE TV</title>
    <!-- Chargement de Tailwind CSS pour un style moderne et responsive sur mobile -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuration de la police et du design mobile-first */
        :root {
            font-family: 'Inter', sans-serif;
        }
        body {
            background-color: #eef2f6; /* Bleu très clair */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 16px;
        }
        .control-card {
            background: linear-gradient(145deg, #ffffff, #f0f4f8);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15), 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        .control-button {
            transition: all 0.15s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border: 1px solid #d1d5db; /* Bordure légère */
        }
        .control-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }
        .app-launch-button {
            background-color: #00A1DE; /* Bleu OQEE/Free */
            color: white;
            font-weight: 700;
            font-size: 2.2rem; 
            height: 120px; /* Légèrement réduit pour compacter */
            box-shadow: 0 12px 25px -5px rgba(0, 161, 222, 0.4);
            letter-spacing: 0.05em;
        }
        .app-launch-button:active {
             background-color: #008CBF;
        }
        /* Style pour tous les boutons d'alimentation (on/off) */
        .power-button-style {
            background-color: #EF4444; /* Rouge Vif */
            color: white;
            font-weight: 600;
        }
        .power-button-style:active {
             background-color: #DC2626;
        }
        /* Style des boutons numériques */
        .num-button {
            background-color: #f9fafb; /* Très clair */
            color: #1f2937; /* Noir */
            font-weight: 700;
            font-size: 1.4rem;
            height: 60px;
        }
        .num-button:active {
            background-color: #e5e7eb;
        }
        .directional-button {
            background-color: #ffffff;
            color: #374151; /* Gris foncé */
            font-size: 1.1rem;
            height: 50px;
        }
        .directional-button:active {
            background-color: #f3f4f6;
        }
        .ok-button {
             background-color: #3b82f6; /* Bleu Vif */
             color: white;
             font-weight: bold;
             height: 60px;
        }
        .ok-button:active {
             background-color: #2563eb;
        }
        .volume-button {
             background-color: #fcd34d; /* Jaune doux */
             color: #4b5563;
             font-weight: bold;
             height: 50px;
        }
        .volume-button:active {
             background-color: #fbbf24;
        }
        .loading {
            cursor: not-allowed;
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body class="selection:bg-indigo-200">
    <div id="app-container" class="w-full max-w-sm control-card p-8 rounded-3xl border border-gray-200">
        
        <!-- Zone de messages d'état (minimaliste) -->
        <div id="status-message" class="bg-indigo-100 text-indigo-800 p-4 rounded-xl text-center mb-8 text-sm font-medium border border-indigo-200">
            Prêt.
        </div>
        
        <!-- 1. Boutons Allumer et Éteindre côte à côte -->
        <div class="flex justify-between items-center mb-8 space-x-4">
            <!-- Bouton Allumer -->
            <button id="power-on-btn" 
                    data-key="on" 
                    data-capability="switch" 
                    class="control-button power-button-style w-1/2 py-3 rounded-xl text-base flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M13 3h-2v10h2V3zM12 11c-4.411 0-8 3.589-8 8s3.589 8 8 8 8-3.589 8-8-3.589-8-8-8zm0 14c-3.309 0-6-2.691-6-6s2.691-6 6-6 6 2.691 6 6-2.691 6-6 6z"/>
                </svg>
                <span>Allumer</span>
            </button>
            
            <!-- Bouton Éteindre -->
            <button id="power-off-btn" 
                    data-key="off" 
                    data-capability="switch" 
                    class="control-button power-button-style w-1/2 py-3 rounded-xl text-base flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M13 3h-2v10h2V3zM12 11c-4.411 0-8 3.589-8 8s3.589 8 8 8 8-3.589 8-8-3.589-8-8-8zm0 14c-3.309 0-6-2.691-6-6s2.691-6 6-6 6 2.691 6 6-2.691 6-6 6z"/>
                </svg>
                <span>Éteindre</span>
            </button>
        </div>

        <!-- 2. Bouton Lancement Direct OQEE (TV) -->
        <button id="launch-oqee-btn" 
                data-app-id="znCs95n93Q.OqeeTV" 
                class="control-button app-launch-button w-full rounded-2xl mb-8 flex flex-col items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 24 24" fill="currentColor">
                <path d="M21 3H3C1.895 3 1 3.895 1 5v12c0 1.105.895 2 2 2h7l-2 3h8l-2-3h7c1.105 0 2-.895 2-2V5c0-1.105-.895-2-2-2zm-1 14H4V6h16v11z"/>
            </svg>
            <span class="text-3xl font-extrabold mt-1">TV</span> 
        </button>
        
        <!-- 3. Commandes Numériques (0-9) -->
        <div class="grid grid-cols-3 gap-3 mb-8">
            <button data-key="1" data-capability="remoteControl" class="control-button num-button rounded-xl py-3">1</button>
            <button data-key="2" data-capability="remoteControl" class="control-button num-button rounded-xl py-3">2</button>
            <button data-key="3" data-capability="remoteControl" class="control-button num-button rounded-xl py-3">3</button>
            
            <button data-key="4" data-capability="remoteControl" class="control-button num-button rounded-xl py-3">4</button>
            <button data-key="5" data-capability="remoteControl" class="control-button num-button rounded-xl py-3">5</button>
            <button data-key="6" data-capability="remoteControl" class="control-button num-button rounded-xl py-3">6</button>
            
            <button data-key="7" data-capability="remoteControl" class="control-button num-button rounded-xl py-3">7</button>
            <button data-key="8" data-capability="remoteControl" class="control-button num-button rounded-xl py-3">8</button>
            <button data-key="9" data-capability="remoteControl" class="control-button num-button rounded-xl py-3">9</button>
            
            <div class="col-span-1"></div> <!-- Espace vide à gauche de 0 -->
            <button data-key="0" data-capability="remoteControl" class="control-button num-button rounded-xl py-3">0</button>
            <div class="col-span-1"></div> <!-- Espace vide à droite de 0 -->
        </div>


        <!-- 4. Commandes de Navigation (D-Pad) -->
        <div class="flex justify-center mb-8">
            <div class="grid grid-cols-3 gap-2 w-48">
                <!-- Haut -->
                <button data-key="UP" data-capability="remoteControl" class="col-start-2 control-button directional-button rounded-xl">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L6 8h12z"/></svg>
                </button>
                <!-- Gauche -->
                <button data-key="LEFT" data-capability="remoteControl" class="col-start-1 control-button directional-button rounded-xl">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20l-8-8 8-8v4h8v8h-8z"/></svg>
                </button>
                <!-- OK/Enter -->
                <button data-key="ENTER" data-capability="remoteControl" class="control-button ok-button rounded-xl">
                    OK
                </button>
                <!-- Droite -->
                <button data-key="RIGHT" data-capability="remoteControl" class="col-start-3 control-button directional-button rounded-xl">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 24 24" fill="currentColor"><path d="M14 20l8-8-8-8v4H6v8h8z"/></svg>
                </button>
                <!-- Bas -->
                <button data-key="DOWN" data-capability="remoteControl" class="col-start-2 control-button directional-button rounded-xl">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22l6-6H6z"/></svg>
                </button>
            </div>
        </div>

        <!-- 5. Commandes de Volume -->
        <div class="flex justify-between items-center mb-8 space-x-4">
            <!-- Bouton Muet (Mute) -->
            <button data-key="MUTE" data-capability="audioVolume" class="control-button volume-button w-1/3 py-3 rounded-xl flex items-center justify-center space-x-1 text-base">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm-2 15h4v-2h-4v2zm0-4h4V7h-4v6z"/>
                </svg>
                <span>Mute</span>
            </button>
             <!-- Bouton Volume Moins (Icône seule) -->
            <button data-key="VOLUME_DOWN" data-capability="audioVolume" class="control-button volume-button w-1/3 py-3 rounded-xl flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M18 13h-4v4h-2v-4H8v-2h4V8h2v4h4v2z"/>
                </svg>
            </button>
            <!-- Bouton Volume Plus (Icône seule) -->
            <button data-key="VOLUME_UP" data-capability="audioVolume" class="control-button volume-button w-1/3 py-3 rounded-xl flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M18 13h-4v4h-2v-4H8v-2h4V8h2v4h4v2z"/>
                </svg>
            </button>
        </div>
        
        <!-- 6. Touches Essentielles (Home/Retour) -->
        <div class="flex justify-between items-center mb-4 space-x-4">
            <!-- Bouton Retour -->
            <button data-key="BACK" data-capability="remoteControl" class="control-button directional-button w-1/2 py-3 rounded-xl flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15v-4H7V9h4V5l6 6-6 6z"/></svg>
                <span>Retour</span>
            </button>
            <!-- Bouton Accueil (Home) -->
            <button data-key="HOME" data-capability="remoteControl" class="control-button directional-button w-1/2 py-3 rounded-xl flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 5.69l5-4.5V3h3v2h-2l-1-1v10h2v2h-3v-2l-1-1v-4L12 5.69zM12 3L2 12h3v8h14v-8h3L12 3z"/></svg>
                <span>Accueil</span>
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const statusMessage = document.getElementById('status-message');
            const powerOnBtn = document.getElementById('power-on-btn'); 
            const powerOffBtn = document.getElementById('power-off-btn'); 
            const launchOqeeBtn = document.getElementById('launch-oqee-btn');
            
            // Collecte de tous les boutons de commande
            const controlButtons = document.querySelectorAll('.control-button[data-key]');

            // --- CONFIGURATION FINALE ---
            const SMARTTHINGS_TOKEN = "a3722370-c705-4739-8709-eef82c298ce2"; 
            const TV_DEVICE_ID = "a446a209-f9d7-7972-e908-a1a41eb7f093";
            const API_URL = `https://api.smartthings.com/v1/devices/${TV_DEVICE_ID}/commands`;
            // --- FIN CONFIGURATION ---

            let isSendingCommand = false;
            const THROTTLE_DELAY_MS = 300; 
            const LONG_THROTTLE_DELAY_MS = 1500; 

            function setButtonDisabled(button, disabled) {
                button.classList.toggle('loading', disabled);
            }

            function setAllButtonsDisabled(disabled) {
                controlButtons.forEach(btn => btn.classList.toggle('loading', disabled));
                isSendingCommand = disabled;
            }

            // Fonction de mise à jour du statut, simplifiée pour ne montrer que le message
            function updateStatus(message, isError = false) {
                statusMessage.className = `p-4 rounded-xl text-center mb-8 text-sm font-medium border ${isError ? 'bg-red-100 text-red-800 border-red-300' : 'bg-indigo-100 text-indigo-800 border-indigo-300'}`;
                // Suppression de l'heure et de la mention "Bienvenue"
                statusMessage.innerHTML = message;
                console.log(message);
            }

            async function sendCommand(commands, description, throttleTime) {
                updateStatus(`Envoi de l'action : ${description}...`);
                setAllButtonsDisabled(true); 

                try {
                    let response;
                    const maxRetries = 5;
                    const initialDelay = 1000;
                    
                    for (let attempt = 0; attempt < maxRetries; attempt++) {
                        response = await fetch(API_URL, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${SMARTTHINGS_TOKEN}`,
                                'Content-Type': 'application/json; charset=utf-8'
                            },
                            body: JSON.stringify({ commands: commands })
                        });

                        if (response.ok || response.status !== 429) {
                            break; 
                        }

                        // Backoff exponentiel pour l'erreur 429
                        const delay = initialDelay * Math.pow(2, attempt);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        if (attempt === maxRetries - 1) {
                            break;
                        }
                    }

                    if (response.ok) {
                        updateStatus(`${description} : Commande réussie.`);
                    } else if (response.status === 429) {
                        updateStatus("Erreur 429 : Requêtes trop rapides. Veuillez réessayer dans quelques secondes.", true);
                    } else {
                        const errorData = await response.json().catch(() => ({ message: 'Réponse illisible ou vide.' }));
                        const detailedError = errorData.message || JSON.stringify(errorData) || 'Erreur inconnue.';
                        updateStatus(`${description} : ÉCHEC (Code ${response.status}). Détail : ${detailedError}`, true);
                    }
                } catch (error) {
                    updateStatus(`Erreur réseau : ${error.message}`, true);
                } finally {
                    setTimeout(() => {
                        setAllButtonsDisabled(false);
                        updateStatus("Prêt.");
                    }, throttleTime);
                }
            }
            
            // --- Gestion des commandes de Lancement d'App ---
            launchOqeeBtn.addEventListener('click', () => {
                if (isSendingCommand) return;
                const appId = launchOqeeBtn.getAttribute('data-app-id');
                const commands = [{
                    component: "main",
                    capability: "custom.launchapp",
                    command: "launchApp",
                    arguments: [appId]
                }];
                sendCommand(commands, "Lancement OQEE TV", LONG_THROTTLE_DELAY_MS);
            });
            
            // --- Gestion des commandes dynamiques (Power, Volume, Navigation, Numérique) ---
            controlButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (isSendingCommand) return;
                    
                    const key = button.getAttribute('data-key');
                    const capability = button.getAttribute('data-capability');
                    let command = "sendKey"; 
                    let description = `Action '${key}'`;
                    let throttleTime = THROTTLE_DELAY_MS;
                    let argumentsArray = [key];

                    // Cas particulier : Marche/Arrêt
                    if (capability === "switch") {
                        command = key; 
                        description = (key === 'on' ? "Allumer la TV" : "Éteindre la TV");
                        argumentsArray = []; 
                        throttleTime = LONG_THROTTLE_DELAY_MS;
                    } 
                    // Cas particulier : Volume
                    else if (capability === "audioVolume") {
                        command = key.toLowerCase().replace('_', '');
                        description = `Contrôle Volume (${key.split('_')[1] || 'Mute'})`;
                        argumentsArray = []; 
                    } 
                    // Cas général : Remote Control (Navigation, Home, Back, Numérique)
                    else if (capability === "remoteControl") {
                         description = (key.length === 1 && !isNaN(parseInt(key))) ? `Changement de chaîne: ${key}` : `Navigation '${key}'`;
                    }

                    const commands = [{
                        component: "main",
                        capability: capability,
                        command: command,
                        arguments: argumentsArray
                    }];

                    sendCommand(commands, description, throttleTime);
                });
            });

            // Initialisation avec le message minimal
            updateStatus("Prêt.");
        });
    </script>
</body>
</html>

