<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Télécommande OQEE TV Numérique Fiable</title>
    <!-- Chargement de Tailwind CSS pour un style moderne et responsive sur mobile -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuration de la police et du design mobile-first */
        :root {
            font-family: 'Inter', sans-serif;
        }
        body {
            background-color: #eef2f6; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 16px;
        }
        .control-card {
            background: linear-gradient(145deg, #ffffff, #f0f4f8);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15), 0 5px 15px rgba(0, 0, 0, 0.05);
            max-width: 400px;
        }
        .control-button {
            transition: all 0.15s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border: 1px solid #d1d5db;
        }
        .control-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* STYLE : Bouton TV/Lancement App (Bleu) */
        .app-launch-button-style {
            background-color: #3B82F6; 
            color: white;
            font-weight: 700;
            font-size: 1.5rem; 
            height: 70px;
            box-shadow: 0 6px 15px -3px rgba(59, 130, 246, 0.4);
            letter-spacing: 0.05em;
        }
        .app-launch-button-style:active { background-color: #2563EB; }

        /* STYLE : Bouton Allumer (Vert) */
        .power-on-style { background-color: #10B981; color: white; font-weight: 600; }
        .power-off-style { background-color: #EF4444; color: white; font-weight: 600; }

        /* STYLE : Boutons Volume & Chaîne (Ronds) */
        .round-button {
             width: 70px; height: 70px; border-radius: 9999px;
             display: flex; flex-direction: column; align-items: center; justify-content: center;
             padding: 4px;
        }
        .volume-button {
             background-color: #fcd34d; 
             color: #4b5563; font-weight: bold;
        }
        .volume-button:active { background-color: #fbbf24; }
        
        /* STYLE : Touches Essentielles et Média */
        .essential-button {
            background-color: #ffffff; color: #374151; font-size: 1.1rem; height: 60px; 
            padding-top: 8px; padding-bottom: 8px; 
        }
        .essential-button:active { background-color: #f3f4f6; }

        /* STYLE : Boutons Numériques */
        .num-button { 
            background-color: #f9fafb; 
            color: #1f2937; 
            font-weight: 700; 
            font-size: 1.2rem; 
            height: 50px; 
            border: 1px solid #e5e7eb;
        }

        .loading {
            cursor: not-allowed; opacity: 0.6; pointer-events: none;
        }
    </style>
</head>
<body class="selection:bg-indigo-200">
    <div id="app-container" class="w-full control-card p-6 rounded-3xl border border-gray-200">
        
        <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">Télécommande OQEE TV</h1>
        
        <!-- 1. Boutons Power et Lancement TV -->
        <div class="flex flex-col space-y-4 mb-8">
            <!-- Bouton Lancement Direct OQEE (TV - Bleu) -->
            <button id="launch-oqee-btn" 
                    data-app-id="znCs95n93Q.OqeeTV" 
                    data-capability="custom.launchapp" 
                    class="control-button app-launch-button-style w-full rounded-2xl flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" viewBox="0 0 24 24" fill="currentColor"><path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-10 11H9v2H7v-6h4v2zm5-2h-2V9h-2v2h-2v2h2v2h2v-2h2v-2z"/></svg>
                <span>Lancer OQEE TV</span> 
            </button>
            
            <div class="flex justify-between space-x-4">
                <!-- Bouton Allumer (Vert) -->
                <button id="power-on-btn" 
                        data-key="on" 
                        data-capability="switch" 
                        class="control-button power-on-style w-1/2 rounded-2xl flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M13 3h-2v10h2V3zM12 11c-4.411 0-8 3.589-8 8s3.589 8 8 8 8-3.589 8-8-3.589-8-8-8zm0 14c-3.309 0-6-2.691-6-6s2.691-6 6-6 6 2.691 6 6-2.691 6-6 6z"/>
                    </svg>
                    <span>ON</span>
                </button>

                <!-- Bouton Éteindre (Rouge) -->
                <button id="power-off-btn" 
                        data-key="off" 
                        data-capability="switch" 
                        class="control-button power-off-style w-1/2 rounded-2xl flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M13 3h-2v10h2V3zM12 11c-4.411 0-8 3.589-8 8s3.589 8 8 8 8-3.589 8-8-3.589-8-8-8zm0 14c-3.309 0-6-2.691-6-6s2.691-6 6-6 6 2.691 6 6-2.691 6-6 6z"/>
                    </svg>
                    <span>OFF</span>
                </button>
            </div>
        </div>
        
        <!-- 2. Commandes de Volume / Chaîne / Mute -->
        <div class="flex justify-around items-center mb-8">
            <!-- Contrôle Volume (audioVolume) -->
            <div class="flex flex-col space-y-3 items-center">
                <span class="text-sm font-semibold text-gray-600 mb-1">Volume</span>
                <button data-command="volumeUp" data-capability="audioVolume" class="control-button volume-button round-button">
                    <span class="text-2xl font-black">+</span>
                </button>
                <button data-command="volumeDown" data-capability="audioVolume" class="control-button volume-button round-button">
                    <span class="text-2xl font-black">-</span>
                </button>
                 <!-- Mute (audioMute) -->
                <button data-command="mute" data-capability="audioMute" class="control-button essential-button rounded-full w-[70px] h-[70px] mt-4 flex items-center justify-center bg-gray-200 hover:bg-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .9-.22 1.74-.63 2.5l1.63 1.63c.66-1.09 1.05-2.35 1.05-3.63 0-4.31-3.52-7.9-7.84-7.9-.55 0-1.07.09-1.57.24l2.12 2.12c.31-.05.63-.08.95-.08 2.07 0 3.75 1.68 3.75 3.75zm-9.98 0l-4.42-4.42-1.41 1.41L5 12l-1.41 1.41 1.41 1.41 4.42-4.42zM5 12h2v.5h-2z"/></svg>
                </button>
            </div>
            
            <!-- Contrôle Chaîne +/- (tvChannel) -->
            <div class="flex flex-col space-y-3 items-center">
                <span class="text-sm font-semibold text-gray-600 mb-1">Chaîne +/-</span>
                 <button data-command="channelUp" data-capability="tvChannel" class="control-button app-launch-button-style round-button w-[70px] h-[70px] flex flex-col justify-center items-center">
                    <span class="text-2xl font-black">CH+</span>
                 </button>
                 <button data-command="channelDown" data-capability="tvChannel" class="control-button app-launch-button-style round-button w-[70px] h-[70px] flex flex-col justify-center items-center">
                    <span class="text-2xl font-black">CH-</span>
                 </button>
                 <!-- Espace pour l'alignement -->
                 <div class="w-[70px] h-[70px] mt-4"></div>
            </div>
        </div>

        <!-- 3. Saisie Numérique de Chaîne (via OCF Keypress) -->
        <div class="p-4 bg-gray-100 rounded-xl border border-gray-200">
            <p class="text-sm font-semibold text-gray-600 mb-3 text-center">Saisie de Chaîne Précise (via Touches Virtuelles)</p>
            
            <!-- Affichage du numéro de chaîne en cours de saisie -->
            <div id="channel-display" class="bg-white p-3 mb-4 rounded-lg text-3xl text-center font-mono border border-gray-300 min-h-[56px] flex items-center justify-center text-gray-700">
                _
            </div>

            <!-- Pavé Numérique -->
            <div class="grid grid-cols-3 gap-3">
                <button data-num="1" class="control-button num-button rounded-xl py-3">1</button>
                <button data-num="2" class="control-button num-button rounded-xl py-3">2</button>
                <button data-num="3" class="control-button num-button rounded-xl py-3">3</button>
                
                <button data-num="4" class="control-button num-button rounded-xl py-3">4</button>
                <button data-num="5" class="control-button num-button rounded-xl py-3">5</button>
                <button data-num="6" class="control-button num-button rounded-xl py-3">6</button>
                
                <button data-num="7" class="control-button num-button rounded-xl py-3">7</button>
                <button data-num="8" class="control-button num-button rounded-xl py-3">8</button>
                <button data-num="9" class="control-button num-button rounded-xl py-3">9</button>
                
                <!-- Effacer et Envoyer -->
                <button id="clear-channel-btn" class="control-button num-button rounded-xl py-3 text-red-500 text-sm">
                    EFFACER
                </button>
                
                <button data-num="0" class="control-button num-button rounded-xl py-3">0</button>
                
                <button id="send-channel-btn" class="control-button num-button rounded-xl py-3 bg-indigo-500 text-white hover:bg-indigo-600 border-indigo-600" disabled>
                    OK
                </button>
            </div>
        </div>
        
        <!-- 4. Touches Media (mediaPlayback) -->
        <div class="mt-8 p-4 bg-gray-100 rounded-xl border border-gray-200">
             <p class="text-sm font-semibold text-gray-600 mb-3 text-center">Contrôles Média</p>
            <div class="flex justify-between items-center space-x-2">
                
                <button data-command="rewind" data-capability="mediaPlayback" class="control-button essential-button flex-1 rounded-xl flex items-center justify-center h-12 bg-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M11 6v12l-5.5-3.5L11 6zm7.5 0L13 9.5 18.5 6V3H21v18h-2V6z"/></svg>
                </button>
                <button data-command="play" data-capability="mediaPlayback" class="control-button essential-button flex-1 rounded-xl flex items-center justify-center h-12 bg-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <button data-command="pause" data-capability="mediaPlayback" class="control-button essential-button flex-1 rounded-xl flex items-center justify-center h-12 bg-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>
                <button data-command="fastForward" data-capability="mediaPlayback" class="control-button essential-button flex-1 rounded-xl flex items-center justify-center h-12 bg-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M13 18V6l5.5 3.5L13 18zm-7.5 0L11 14.5 5.5 18V3H3v18h2V6z"/></svg>
                </button>
            </div>
        </div>

        <!-- ENCART DE STATUT EN BAS -->
        <div id="status-message" class="bg-green-100 text-green-800 p-3 rounded-xl text-center text-sm font-medium border border-green-300 mt-4">
            ✅ Télécommande OQEE TV : Prête.
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const statusMessage = document.getElementById('status-message');
            const channelDisplay = document.getElementById('channel-display');
            const sendChannelBtn = document.getElementById('send-channel-btn');
            const clearChannelBtn = document.getElementById('clear-channel-btn');
            
            // État de la saisie de chaîne
            let currentChannelInput = "";

            // Collecte de tous les boutons de commande (hors pavé numérique)
            const controlButtons = document.querySelectorAll('.control-button[data-command], .app-launch-button-style');
            // Collecte des boutons numériques
            const numButtons = document.querySelectorAll('.num-button[data-num]');

            // --- CONFIGURATION FINALE : Jeton mis à jour ---
            // NOUVEAU TOKEN D'ACCÈS FOURNI PAR L'UTILISATEUR
            const SMARTTHINGS_TOKEN = "a78a6311-8848-43d0-9993-a44415891465"; 
            // ID de l'appareil (TV)
            const TV_DEVICE_ID = "a446a209-f9d7-7972-e908-a1a41eb7f093";
            // --- FIN CONFIGURATION ---
            
            const COMMAND_API_URL = `https://api.smartthings.com/v1/devices/${TV_DEVICE_ID}/commands`;
            // Délais pour les appels API
            const THROTTLE_DELAY_MS = 300; 
            const LONG_THROTTLE_DELAY_MS = 1500; 
            
            let isSendingCommand = false;

            // Fonction pour désactiver l'interface
            function setAllButtonsDisabled(disabled) {
                // Désactiver tous les boutons de commande principaux
                controlButtons.forEach(btn => btn.classList.toggle('loading', disabled));
                // Désactiver le pavé numérique
                numButtons.forEach(btn => btn.classList.toggle('loading', disabled));
                clearChannelBtn.classList.toggle('loading', disabled);
                // Gérer le bouton OK
                sendChannelBtn.disabled = disabled || currentChannelInput.length === 0;
                isSendingCommand = disabled;
            }

            // Fonction de mise à jour du statut
            function updateStatus(message, isError = false) {
                statusMessage.className = `p-3 rounded-xl text-center text-sm font-medium border ${isError ? 'bg-red-100 text-red-800 border-red-300' : 'bg-green-100 text-green-800 border-green-300'} mt-4`;
                statusMessage.innerHTML = message;
                console.log(message);
            }
            
            // Mise à jour de l'affichage du numéro de chaîne
            function updateChannelDisplay() {
                channelDisplay.textContent = currentChannelInput || "_";
                // Activer le bouton OK si un numéro est entré
                sendChannelBtn.disabled = currentChannelInput.length === 0 || isSendingCommand;
                // Ajuster la couleur du bouton OK
                if (currentChannelInput.length > 0) {
                     sendChannelBtn.classList.remove('bg-indigo-500/50', 'text-gray-400');
                     sendChannelBtn.classList.add('bg-indigo-500', 'text-white');
                } else {
                     sendChannelBtn.classList.remove('bg-indigo-500', 'text-white');
                     sendChannelBtn.classList.add('bg-indigo-500/50', 'text-gray-400');
                }
            }


            // Fonction d'envoi de commande SmartThings (pour Power, Volume, App, CH+/-, et OCF)
            async function sendCommand(commands, description, throttleTime) {
                updateStatus(`Envoi de l'action : ${description}...`);
                setAllButtonsDisabled(true); 

                try {
                    const response = await fetch(COMMAND_API_URL, {
                        method: 'POST',
                        headers: {
                            // Utilisation du nouveau jeton
                            'Authorization': `Bearer ${SMARTTHINGS_TOKEN}`,
                            'Content-Type': 'application/json; charset=utf-8'
                        },
                        body: JSON.stringify({ commands: commands })
                    });

                    if (response.ok) {
                        updateStatus(`${description} : Commande réussie.`, false);
                    } else {
                        let errorDetail = '';
                        try {
                            const errorData = await response.json();
                            errorDetail = errorData.message || JSON.stringify(errorData, null, 2);
                        } catch {
                            errorDetail = response.statusText || 'Réponse non JSON';
                        }
                        // Affichage de toute erreur (y compris 401 si le nouveau jeton ne fonctionne pas)
                        updateStatus(`${description} : ÉCHEC (Code HTTP ${response.status}). Détail : ${errorDetail}`, true);
                    }
                } catch (error) {
                    updateStatus(`Erreur réseau (Fetch) : ${error.message}`, true);
                } finally {
                    // Libérer l'interface après le délai d'attente
                    setTimeout(() => {
                        setAllButtonsDisabled(false);
                        updateStatus("Prêt.");
                        updateChannelDisplay();
                    }, throttleTime);
                }
            }
            
            // Fonction d'envoi de touche virtuelle via OCF (pour les numéros et ENTER)
            async function sendOcfKeyCommand(keyName) {
                const ocfCommand = [{
                    component: "main",
                    capability: "ocf",
                    command: "postOcfCommand",
                    arguments: [
                        "/b2b/channel/tv/remotecontrol",
                        `{"button":"${keyName}"}` // Le nom de la touche, ex: KEY_1, KEY_ENTER
                    ]
                }];
                // Utilisation du délai le plus court pour les touches successives
                // Nous attendons la réponse pour chaque touche avant d'envoyer la suivante.
                await sendCommand(ocfCommand, `Touche OCF: ${keyName}`, THROTTLE_DELAY_MS);
            }


            // --- GESTION DES COMMANDES PRINCIPALES (Volume, Power, App, CH+/-) ---
            controlButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (isSendingCommand) return;
                    
                    const command = button.getAttribute('data-command'); 
                    const capability = button.getAttribute('data-capability');
                    let commands;
                    let description;
                    let throttleTime = THROTTLE_DELAY_MS;

                    // 1. Marche/Arrêt (switch)
                    if (capability === "switch") {
                        const key = button.getAttribute('data-key'); 
                        description = (key === 'on' ? "Allumer la TV" : "Éteindre la TV");
                        throttleTime = LONG_THROTTLE_DELAY_MS;
                        commands = [{
                            component: "main",
                            capability: "switch", 
                            command: key, 
                            arguments: []
                        }];
                    } 
                    // 2. Lancement d'App (custom.launchapp)
                    else if (capability === "custom.launchapp") {
                        const appId = button.getAttribute('data-app-id');
                        description = "Lancement OQEE TV";
                        throttleTime = LONG_THROTTLE_DELAY_MS;
                        commands = [{
                            component: "main",
                            capability: "custom.launchapp",
                            command: "launchApp",
                            arguments: [appId]
                        }];
                    }
                    // 3. Commandes Simples (audioVolume, tvChannel, mediaPlayback, audioMute)
                    else if (['audioVolume', 'tvChannel', 'mediaPlayback', 'audioMute'].includes(capability)) {
                        description = `Commande ${command}`;
                        commands = [{
                            component: "main",
                            capability: capability, 
                            command: command, 
                            arguments: [] 
                        }];
                    }
                    
                    if (commands) {
                        sendCommand(commands, description, throttleTime);
                    } else {
                        updateStatus("Erreur: Type de bouton inconnu.", true);
                    }
                });
            });

            // --- GESTION DU PAVÉ NUMÉRIQUE (setTvChannel via OCF) ---

            // 1. Saisie de chiffre
            numButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (isSendingCommand) return;
                    const num = button.getAttribute('data-num');
                    // Limiter à 4 chiffres maximum
                    if (currentChannelInput.length < 4) {
                        currentChannelInput += num;
                        updateChannelDisplay();
                    }
                });
            });

            // 2. Bouton Effacer
            clearChannelBtn.addEventListener('click', () => {
                if (isSendingCommand) return;
                currentChannelInput = "";
                updateChannelDisplay();
                updateStatus("Saisie de chaîne effacée.");
            });

            // 3. Bouton Envoyer (setTvChannel)
            sendChannelBtn.addEventListener('click', async () => {
                if (isSendingCommand || currentChannelInput.length === 0) return;
                
                const channelNumber = currentChannelInput;
                
                updateStatus(`Composition de la chaîne ${channelNumber}...`);
                setAllButtonsDisabled(true);

                // Itérer sur chaque chiffre et envoyer la commande KEY_X correspondante
                for (const digit of channelNumber) {
                    const keyName = `KEY_${digit}`;
                    // Nous attendons la fin de l'envoi de chaque touche
                    await sendOcfKeyCommand(keyName);
                }

                // Envoyer la touche ENTER pour valider le numéro de chaîne
                await sendOcfKeyCommand('KEY_ENTER');

                updateStatus(`Chaîne ${channelNumber} envoyée via touches virtuelles.`, false);
                
                // Réinitialiser la saisie après l'envoi 
                currentChannelInput = "";
                
                // Libérer l'interface après le délai pour la touche ENTER
                setTimeout(() => {
                    setAllButtonsDisabled(false);
                    updateStatus("Prêt.");
                    updateChannelDisplay();
                }, LONG_THROTTLE_DELAY_MS);
            });


            // Initialisation avec le message minimal
            updateStatus("Télécommande OQEE TV : Jeton d'accès mis à jour. Veuillez tester les commandes.");
            updateChannelDisplay(); // Assurez-vous que l'état initial est affiché
        });
    </script>
</body>
</html>

